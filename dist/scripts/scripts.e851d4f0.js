angular.module("constants",[]).constant("LOCALSTORAGE",!0),angular.module("unchatbar-phone-book",["constants","ui.router","ui.bootstrap","ngStorage","unchatbar-connection","unchatbar-user"]),angular.module("unchatbar-phone-book").provider("PhoneBook",function(){var a=!1;this.setLocalStorage=function(){a=!0},this.$get=["$rootScope","$sessionStorage","$localStorage","Broker",function(b,c,d,e){var f={_storagePhoneBook:{user:{},groups:{}},initStorage:function(){var b=a?d:c;this._storagePhoneBook=b.$default({phoneBook:{user:{},groups:{}}}).phoneBook},addClient:function(a,b){var c=!1;return this._storagePhoneBook.user[a]||a===e.getPeerId()||(b.id=a,this._storagePhoneBook.user[a]=b,c=!0),this._sendUpdateEvent(),c},updateClient:function(a,b){this._storagePhoneBook.user[a]={label:b||a,id:a},this._sendUpdateEvent()},getClient:function(a){return this._storagePhoneBook.user[a]||""},getClientMap:function(){return this._storagePhoneBook.user},removeClient:function(a){delete this._storagePhoneBook.user[a],this._sendUpdateEvent()},copyGroupFromPartner:function(a,b){-1!==_.findIndex(b.users,{id:e.getPeerId()})?(b.editable=!1,this._storagePhoneBook.groups[a]=b,_.forEach(this._storagePhoneBook.groups[a].users,function(a){e.getPeerId()!==a.id&&this.addClient(a.id,{})&&e.connect(a.id)}.bind(this)),this._sendUpdateEvent()):this._storagePhoneBook.groups[a]&&(delete this._storagePhoneBook.groups[a],this._sendUpdateEvent())},addGroup:function(a){var b=e.getPeerId(),c=[{id:e.getPeerId()}];if(b){var d=this.createNewGroupId();this._storagePhoneBook.groups[d]={label:a,users:c,owner:b,editable:!0,id:d}}this._sendUpdateEvent()},updateGroup:function(a,b){this._storagePhoneBook.groups[a]=b,this._sendUpdateEvent()},createNewGroupId:function(){return e.getPeerId()+(new Date).getTime()},getGroup:function(a){return this._storagePhoneBook.groups[a]},removeGroup:function(a){delete this._storagePhoneBook.groups[a],this._sendUpdateEvent()},removeGroupByClient:function(a,b){if(this._storagePhoneBook.groups[b].owner===a)delete this._storagePhoneBook.groups[b];else{var c=_.findIndex(this._storagePhoneBook.groups[b].users,{id:a});-1!==c&&this._storagePhoneBook.groups[b].users.splice(c,1)}this._sendUpdateEvent()},getGroupMap:function(){return _.cloneDeep(this._storagePhoneBook.groups)},_sendUpdateEvent:function(){b.$broadcast("PhoneBookUpdate",{})}};return f}]}),angular.module("unchatbar-phone-book").config(["BrokerProvider","PhoneBookProvider","ProfileProvider","MessageTextProvider","LOCALSTORAGE",function(){PhoneBookProvider.setLocalStorage()}]),angular.module("unchatbar-phone-book").controller("phoneBook",["$scope","$stateParams","MessageText","PhoneBook","Broker",function(a,b,c,d,e){a.form={},a.clientMap={},a.groupMap={},a.selectedUser="",a.selectedGroup="",a.ownPeerId=e.getPeerId(),a.getClientAndGroups=function(){a.clientMap=d.getClientMap(),a.groupMap=d.getGroupMap(),a.selectedGroup&&!a.groupMap[a.selectedGroup]&&a.setGroup(""),a.selectedUser&&!a.clientMap[a.selectedUser]&&a.setClient("")},a.setClient=function(b){c.setRoom("user",b),a.selectedGroup="",a.selectedUser=b},a.setGroup=function(b){c.setRoom("group",b),a.selectedGroup=b,a.selectedUser=""},a.createGroup=function(){d.addGroup(a.form.newGroupName),a.form.newGroupName=""},a.init=function(){a.getClientAndGroups(),a.selectedUser=b.peerId||"",a.selectedGroup=b.groupId||"",b.peerId?a.setClient(b.peerId):b.groupId&&a.setGroup(b.groupId)},a.$on("$stateChangeSuccess",function(){a.init()}),a.$on("PhoneBookUpdate",function(){a.getClientAndGroups()})}]),angular.module("unchatbar-phone-book").controller("phoneBookAdmin",["$scope","$state","$stateParams","$modal","MessageText","PhoneBook","Stream",function(a,b,c,d,e,f,g){a.selectedUser="",a.selectedGroup="",a.clientMap={},a.groupMap={},a.removeClient=function(a){f.removeClient(a),b.go("chat")},a.getClientAndGroups=function(){a.clientMap=f.getClientMap(),a.groupMap=f.getGroupMap(),a.selectedUser=c.peerId||"",a.selectedGroup=c.groupId||""},a.removeGroup=function(a){e.sendRemoveGroup(a,f.getGroup(a).users),f.removeGroup(a),b.go("chat")},a.addUserToGroup=function(){if(a.selectedGroup){var b=a.groupMap[a.selectedGroup].users;e.sendGroupUpdateToUsers(b,a.groupMap[a.selectedGroup]),f.updateGroup(a.selectedGroup,a.groupMap[a.selectedGroup])}},a.removeUserFromGroup=function(){if(a.selectedGroup){var b=f.getGroup(a.selectedGroup).users;e.sendGroupUpdateToUsers(b,a.groupMap[a.selectedGroup]),f.updateGroup(a.selectedGroup,a.groupMap[a.selectedGroup])}},a.getUserName=function(a){return f.getClient(a).label||a},a.streamToClient=function(a){d.open({templateUrl:"views/unchatbar-phone-book/streamOption.html",controller:"modalStreamOption",size:"sm"}).result.then(function(b){g.callUser(a,b)})},a.streamToConferenceByGroupId=function(b){d.open({templateUrl:"views/unchatbar-phone-book/streamOption.html",controller:"modalStreamOption",size:"sm"}).result.then(function(c){g.createOwnStream(c).then(function(d){_.forEach(a.groupMap[b].users,function(a){g.callConference(b,a.id,c,d)})})})},a.$on("PhoneBookUpdate",function(){a.getClientAndGroups()}),a.$on("$stateChangeSuccess",function(){a.selectedUser=c.peerId||"",a.selectedGroup=c.groupId||""})}]),angular.module("unchatbar-phone-book").directive("phoneBookStream",[function(){return{restrict:"E",replace:!0,templateUrl:"views/unchatbar-phone-book/book-stream.html",controller:"phoneBook"}}]),angular.module("unchatbar-phone-book").directive("phoneBookNewGroup",[function(){return{restrict:"E",replace:!0,templateUrl:"views/unchatbar-phone-book/addNewGroup.html",controller:"phoneBookAdmin"}}]),angular.module("unchatbar-phone-book").directive("phoneBook",[function(){return{restrict:"E",replace:!0,templateUrl:"views/unchatbar-phone-book/book.html",controller:"phoneBook"}}]),angular.module("unchatbar-phone-book").directive("phoneBookAdmin",[function(){return{restrict:"E",replace:!0,templateUrl:"views/unchatbar-phone-book/book-admin.html",controller:"phoneBookAdmin"}}]),angular.module("unchatbar-phone-book").directive("activeUser",[function(){return{restrict:"E",replace:!0,templateUrl:"views/unchatbar-phone-book/active-user.html",controller:"phoneBookAdmin"}}]),angular.module("unchatbar-phone-book").run(["$rootScope","PhoneBook",function(a,b){a.$on("ConnectionGetMessageprofile",function(a,c){b.updateClient(c.peerId,c.message.profile.label||"")}),a.$on("ConnectionGetMessageupdateUserGroup",function(a,c){b.copyGroupFromPartner(c.message.group.id,c.message.group)}),a.$on("ConnectionGetMessageremoveGroup",function(a,c){b.removeGroupByClient(c.peerId,c.message.roomId)}),a.$on("BrokerPeerConnection",function(a,c){b.addClient(c.connection.peer,{label:c.connection.peer})}),a.$on("BrokerPeerCall",function(a,c){b.addClient(c.client.peer,c.client.metadata.profile)})}]);